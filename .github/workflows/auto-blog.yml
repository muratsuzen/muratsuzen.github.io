name: Auto Blog Post with OpenAI

on:
  schedule:
    - cron: '45 10 * * *'  # Her gün 13:45 TR saatiyle (10:45 UTC)
  workflow_dispatch:

jobs:
  generate-and-commit:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install OpenAI SDK
        run: pip install openai

      - name: Generate blog post using OpenAI
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          python - <<EOF
import openai
from datetime import datetime
import re
import os

openai.api_key = os.getenv("OPENAI_API_KEY")

date_str = datetime.now().strftime("%Y-%m-%d")
timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")

title_prompt = "Give me a trending software development blog post title for today."
title_response = openai.ChatCompletion.create(
    model="gpt-4",
    messages=[{"role": "user", "content": title_prompt}],
    temperature=0.8
)
title = title_response["choices"][0]["message"]["content"].strip()
slug = re.sub(r'[^a-z0-9]+', '-', title.lower()).strip('-')
filename = f"_posts/{date_str}-{slug}.md"

content_prompt = f"Write a detailed software development blog post with at least 1000 words. Title: '{title}'. Include practical examples, clear explanations, and code snippets if applicable. Format in markdown."
content_response = openai.ChatCompletion.create(
    model="gpt-4",
    messages=[{"role": "user", "content": content_prompt}],
    temperature=0.7
)
content = content_response["choices"][0]["message"]["content"].strip()

os.makedirs("_posts", exist_ok=True)
with open(filename, 'w') as f:
    f.write(f\"\"\"---
title: "{title}"
author: Murat Süzen
date: {timestamp} +0300
categories: [Software, Development]
---

{content}
\"\"\")
EOF

      - name: Commit and push
        run: |
          git config --global user.name 'github-actions'
          git config --global user.email 'github-actions@github.com'
          git add _posts/
          git commit -m "New blog post for $(date +'%Y-%m-%d')" || echo "No changes to commit"
          git push
